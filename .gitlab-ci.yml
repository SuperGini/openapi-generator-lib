image: openjdk:21-slim-bookworm

stages:
  - build
  - publish

workflow:
  rules:
    # Allow manual pipeline runs via the GitLab UI.
    # This is where you provide your "keyboard input" via the form.
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always

build-stage:
  stage: build
  variables:
    openApiFileName:
      value: "default-value"
  script:
    - chmod +x ./gradlew
    - ./gradlew compileJava -PopenApiFileName="$openApiFileName"

publish-stage:
  stage: publish
  variables:
    ci_JOB_TOKEN_OPEN_API:
      value: default-value
    openApiFileName:
      value: "default-value"
  script:
    - chmod +x ./gradlew
    # Extract version from OpenAPI YAML file
    - version=$(yq e '.info.version' "$openApiFileName".yaml)
    # Replace version in build.gradle.kts
    - sed -i "s/version = \".*\"/version = \"$version\"/" build.gradle.kts
    - ./gradlew publish -Pci_JOB_TOKEN_OPEN_API="$ci_JOB_TOKEN_OPEN_API" -PopenApiFileName="$openApiFileName"

